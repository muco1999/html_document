<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NET MONITOR</title>

<script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
body {
  margin: 0;
  font-family: system-ui, Arial, sans-serif;
  background: #0a0a0a;
  color: #00ffcc;
  display: flex;
  justify-content: center;
  align-items: center;
  min-height: 100vh;
}

.box {
  width: 100%;
  max-width: 380px;
  border: 1px solid #00ffcc;
  border-radius: 12px;
  padding: 16px;
  background: #000;
}

h1 {
  text-align: center;
  font-size: 18px;
  margin-bottom: 12px;
}

.log {
  background: #020617;
  color: #22c55e;
  font-size: 12px;
  padding: 10px;
  height: 120px;
  overflow-y: auto;
  border-radius: 8px;
}

.progress {
  margin-top: 12px;
  height: 6px;
  background: #020617;
  border-radius: 6px;
  overflow: hidden;
}

.bar {
  width: 0%;
  height: 100%;
  background: #22c55e;
  transition: width 0.2s linear;
}

.result {
  margin-top: 10px;
  font-size: 13px;
}

.big {
  font-size: 26px;
  text-align: center;
  margin-bottom: 10px;
  color: #22c55e;
}

.row {
  margin-bottom: 6px;
}
</style>
</head>

<body>

<div class="box">
<h1>NET MONITOR</h1>

<div id="log" class="log">starting...</div>

<div class="progress"><div id="bar" class="bar"></div></div>

<div id="result" class="result">
  <div class="big" id="speed">– Mbps</div>
  <div class="row">IP: <span id="ip">–</span></div>
  <div class="row">Country: <span id="country">–</span></div>
  <div class="row">City: <span id="city">–</span></div>
  <div class="row">ISP: <span id="isp">–</span></div>
  <div class="row">Last update: <span id="time">–</span></div>
</div>
</div>

<script>
const tg = window.Telegram.WebApp;
tg.expand();

const SCAN_INTERVAL = 1000; // ⏱ ИЗМЕНИ ЗДЕСЬ

let running = false;

const logBox = document.getElementById("log");
const bar = document.getElementById("bar");

function log(t) {
  logBox.textContent += "\n> " + t;
  logBox.scrollTop = logBox.scrollHeight;
}

async function getIPInfo() {
  const apis = ["https://ipwho.is/", "https://ipapi.co/json/"];

  for (const url of apis) {
    try {
      const r = await fetch(url, { cache: "no-store" });
      const j = await r.json();
      if (j.ip || j.ip_address) {
        return {
          ip: j.ip || j.ip_address,
          country: j.country || j.country_name,
          city: j.city || "unknown",
          isp: j.connection?.isp || j.org || "unknown"
        };
      }
    } catch {}
  }
  return null;
}

async function testSpeed() {
  const url = "https://speed.cloudflare.com/__down?bytes=256000"; // 256KB
  const start = performance.now();

  try {
    const r = await fetch(url, { cache: "no-store" });
    await r.arrayBuffer();
    const end = performance.now();
    const time = (end - start) / 1000;
    return ((0.256 * 8) / time).toFixed(2);
  } catch {
    return null;
  }
}

function sleep(ms) {
  return new Promise(r => setTimeout(r, ms));
}

async function scanLoop() {
  if (running) return;
  running = true;

  while (true) {
    bar.style.width = "10%";
    log("scan started");

    const ip = await getIPInfo();
    bar.style.width = "50%";

    const speed = await testSpeed();
    bar.style.width = "100%";

    if (ip && speed) {
      document.getElementById("speed").textContent = speed + " Mbps";
      document.getElementById("ip").textContent = ip.ip;
      document.getElementById("country").textContent = ip.country;
      document.getElementById("city").textContent = ip.city;
      document.getElementById("isp").textContent = ip.isp;
      document.getElementById("time").textContent = new Date().toLocaleTimeString();

      tg.sendData(JSON.stringify({
        speed,
        ip,
        time: new Date().toISOString()
      }));
    } else {
      log("scan failed");
    }

    bar.style.width = "0%";
    log("sleeping " + SCAN_INTERVAL/1000 + "s");
    await sleep(SCAN_INTERVAL);
  }
}

scanLoop();
</script>

</body>
</html>