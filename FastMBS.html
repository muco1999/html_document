<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NET TEST</title>

<script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
body {
  margin: 0;
  font-family: system-ui, Arial, sans-serif;
  background: #0a0a0a;
  color: #00ffcc;
  display: flex;
  justify-content: center;
  align-items: center;
  min-height: 100vh;
}

.box {
  width: 100%;
  max-width: 380px;
  border: 1px solid #00ffcc;
  border-radius: 12px;
  padding: 16px;
  background: #000;
}

h1 {
  text-align: center;
  font-size: 18px;
  margin-bottom: 12px;
}

.big {
  font-size: 26px;
  text-align: center;
  margin-bottom: 10px;
  color: #22c55e;
}

.row {
  font-size: 13px;
  margin-bottom: 6px;
}

button {
  width: 100%;
  padding: 12px;
  margin-top: 12px;
  background: none;
  border: 1px solid #00ffcc;
  color: #00ffcc;
  border-radius: 8px;
  font-size: 15px;
}

button:disabled {
  opacity: 0.6;
}
.small {
  font-size: 12px;
  color: #22c55e;
}
</style>
</head>

<body>

<div class="box">
<h1>NET TEST</h1>

<div class="big" id="speed">– Mbps</div>

<div class="row">Ping: <span id="ping">– ms</span></div>
<div class="row">IP: <span id="ip">–</span></div>
<div class="row">Country: <span id="country">–</span></div>
<div class="row">City: <span id="city">–</span></div>
<div class="row">ISP: <span id="isp">–</span></div>
<div class="row small">Time: <span id="time">–</span></div>

<button id="btn" onclick="runTest()">TEST</button>
</div>

<script>
const tg = window.Telegram.WebApp;
tg.expand();

let running = false;

async function getIP() {
  try {
    const r = await fetch("https://ipwho.is/");
    return await r.json();
  } catch {
    return null;
  }
}

async function pingTest() {
  const start = performance.now();
  try {
    await fetch("https://1.1.1.1/cdn-cgi/trace", { cache: "no-store" });
    return Math.round(performance.now() - start);
  } catch {
    return null;
  }
}

async function speedTest() {
  const tests = [200000, 800000]; // warmup + main
  let bits = 0;
  let time = 0;

  for (const bytes of tests) {
    const start = performance.now();
    try {
      const r = await fetch(
        "https://speed.cloudflare.com/__down?bytes=" + bytes,
        { cache: "no-store" }
      );
      await r.arrayBuffer();
      const end = performance.now();

      bits += bytes * 8;
      time += (end - start) / 1000;
    } catch {
      return null;
    }
  }

  return (bits / time / 1_000_000).toFixed(2);
}

async function runTest() {
  if (running) return;
  running = true;

  const btn = document.getElementById("btn");
  btn.disabled = true;
  btn.textContent = "TESTING...";

  document.getElementById("speed").textContent = "– Mbps";
  document.getElementById("time").textContent = "–";

  const ping = await pingTest();
  if (ping) document.getElementById("ping").textContent = ping + " ms";

  const ip = await getIP();
  if (ip) {
    document.getElementById("ip").textContent = ip.ip;
    document.getElementById("country").textContent = ip.country;
    document.getElementById("city").textContent = ip.city;
    document.getElementById("isp").textContent = ip.connection?.isp || "–";
  }

  const speed = await speedTest();
  if (speed) {
    document.getElementById("speed").textContent = speed + " Mbps";
    document.getElementById("time").textContent = new Date().toLocaleTimeString();

    tg.sendData(JSON.stringify({
      speed,
      ping,
      ip,
      time: new Date().toISOString()
    }));
  }

  btn.disabled = false;
  btn.textContent = "TEST";
  running = false;
}
</script>

</body>
</html>